<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE workflow [

<!ENTITY ACCOUNT "hfv3gfs">
<!ENTITY ACCOUNT_DA "hfv3gfs">

<!ENTITY PARTITION "xjet:vjet:sjet:tjet">
<!ENTITY PARTITION_DA "kjet">
<!ENTITY QUEUE "batch">
<!ENTITY RES_DA "rtma-kjet">
<!ENTITY RES_POST "rtma-kjet">

<!ENTITY SYSTEM_ID "RTMA_3D"> 
<!ENTITY HOMEBASE_DIR "/misc/whome/Gang.Zhao/rtma3d_repo/GSD_dev1_jjob">
<!ENTITY DATABASE_DIR "/mnt/lfs3/projects/hfv3gfs/Gang.Zhao/gsd_dev1_jjob_databasedir">
<!ENTITY OBS_DIR "/public/data">
<!ENTITY NCL_VER "6.5.0">

<!ENTITY SCRIPTS "&HOMEBASE_DIR;/bin">
<!ENTITY STATIC_DIR "&HOMEBASE_DIR;/static">

<!ENTITY WPS_ROOT "&HOMEBASE_DIR;/exec/WPS">
<!ENTITY WRF_ROOT "&HOMEBASE_DIR;/exec/WRF">
<!ENTITY UNIPOST_EXEC "&HOMEBASE_DIR;/exec/UPP">
<!ENTITY SMARTINIT_EXEC "&HOMEBASE_DIR;/exec/smartinit"> 
<!ENTITY WGRIB1 "&HOMEBASE_DIR;/exec/UPP/wgrib">
<!ENTITY WGRIB "&HOMEBASE_DIR;/exec/UPP/wgrib2">
<!ENTITY GSI_ROOT "&HOMEBASE_DIR;/exec/GSI">
<!ENTITY FIX_ROOT "&STATIC_DIR;/GSI">

<!ENTITY HOMErtma3d "&HOMEBASE_DIR;">
<!ENTITY SCRIPT_DIR "&HOMEBASE_DIR;/scripts">
<!ENTITY JJOB_DIR   "&HOMEBASE_DIR;/jobs">
<!ENTITY WRKFLW_DIR "&HOMEBASE_DIR;/workflow">

<!ENTITY MACHINE    "jet">
<!ENTITY machine    "jet">

<!-- Definition Block of Datasets for Real-Time RTMA3D on Jet -->
<!--     (Better DO NOT TOUCH this Block)                     -->
<!ENTITY HRRR_DIR "/home/rtrr/hrrr">
<!ENTITY SST_DIR "&OBS_DIR;/grids/ncep/sst/0p083deg/grib2">

<!ENTITY GFS_DIR "&OBS_DIR;/grids/gfs/0p5deg/grib2">
<!ENTITY ENKFFCST_DIR "&OBS_DIR;/grids/enkf/atm">

<!ENTITY AIRCRAFT_REJECT "/home/rtruc/amdar_reject_lists">
<!ENTITY SFCOBS_USELIST "/lfs3/projects/amb-verif/mesonet_uselists">
<!ENTITY PREPBUFR_DIR "&OBS_DIR;/grids/rap/prepbufr">
<!ENTITY PREPBUFR_EARLY_DIR "&OBS_DIR;/grids/rap/prepbufr_test">
<!ENTITY PREPBUFR_SAT_DIR "&OBS_DIR;/grids/rap/radiance">
<!ENTITY LIGHTNING_DIR "&OBS_DIR;/lightning">
<!ENTITY BUFRLIGHTNING_DIR "/mnt/lfs1/projects/rtwbl/mhu/rapobs/radiance">
<!ENTITY RADAR_DIR "&OBS_DIR;/radar/mrms">
<!ENTITY SATELLITE_DIR "&OBS_DIR;/sat/nasa">
<!ENTITY LANGLEY_BUFR_DIR "&OBS_DIR;/grids/rap/langley">
<!ENTITY RADVELLEV2_DIR "&OBS_DIR;/grids/rap/nexrad">
<!ENTITY RADVELLEV2P5_DIR "&OBS_DIR;/grids/rap/radwnd">
<!ENTITY SATWND_DIR "&OBS_DIR;/grids/rap/satwnd">
<!ENTITY NACELLE_RSD "&OBS_DIR;/tower/restricted/nacelle/netcdf">
<!ENTITY TOWER_RSD "&OBS_DIR;/tower/restricted/met/netcdf">
<!ENTITY TOWER_NRSD "&OBS_DIR;/tower/public/netcdf">
<!ENTITY SODAR_NRSD "&OBS_DIR;/profiler/wind/external/netcdf">
<!ENTITY TAMDAR_DIR "&OBS_DIR;/acars/raw/netcdf">
<!ENTITY NCEPSNOW_DIR "&OBS_DIR;/grids/ncep/snow/ims96/grib2">
<!ENTITY HIGHRES_SST_DIR "&OBS_DIR;/grids/ncep/sst/0p083deg/grib2">
<!ENTITY HIGHRES_SST14KM_DIR "&OBS_DIR;/grids/ncep/sst/grib">
<!ENTITY TCVITALS_DIR "&OBS_DIR;/nhc/tcvitals">
<!ENTITY STICKNET_DIR "&OBS_DIR;/vortex-se/stesonet">
<!-- END OF BLOCK -->

<!-- Definition Block of Top Directories for running Real-Time RTMA3D on Jet -->
<!ENTITY LOG_DIR "&DATABASE_DIR;/log">
<!ENTITY DATAROOT_ENS "&DATABASE_DIR;/gfsenkf">
<!ENTITY DATAROOT "&DATABASE_DIR;/run">
<!ENTITY DATAROOT_BC "&DATABASE_DIR;/run">
<!ENTITY DATAROOT_PCYC "&DATABASE_DIR;/run">
<!-- END OF BLOCK -->

<!ENTITY POST_NAME "hrconus">

<!-- Definition Block of RESOURCES used to run Real-Time RTMA3D on Jet -->
<!ENTITY SMARTINIT_PROC "1">
<!ENTITY CONVENTIONAL_PROC "1">
<!ENTITY LIGHTNING_PROC "1">
<!ENTITY RADAR_PROC "33">
<!ENTITY SATELLITE_PROC "1">
<!ENTITY GSI_HYB_PROC "280">
<!ENTITY GSI_DIAG_PROC "1">
<!ENTITY RADARLINKS_PROC "1">

<!ENTITY POST_PROC "32">
<!ENTITY NCL_PROC "1">
<!ENTITY NCL_MAIN_PROC "8">
<!ENTITY CLEAN_PROC "1">

<!ENTITY SMARTINIT_RESOURCES "<walltime>00:10:00</walltime><memory>10G</memory>">
<!ENTITY CLEAN_RESOURCES "<walltime>00:45:00</walltime><memory>500M</memory>">
<!ENTITY LIGHTNING_RESOURCES "<walltime>00:05:00</walltime><memory>4G</memory>">
<!ENTITY CONVENTIONAL_RESOURCES "<walltime>00:05:00</walltime><memory>2G</memory>">
<!ENTITY RADAR_RESOURCES "<walltime>00:05:00</walltime>">
<!ENTITY SATELLITE_RESOURCES "<walltime>00:05:00</walltime><memory>10G</memory>">
<!ENTITY GSI_HYB_RESOURCES "<walltime>00:40:00</walltime>">
<!ENTITY GSI_DIAG_RESOURCES "<walltime>00:05:00</walltime><memory>600M</memory>">
<!ENTITY POST_RESOURCES "<walltime>00:45:00</walltime>">
<!ENTITY NCL_RESOURCES "<walltime>00:55:00</walltime>">
<!ENTITY NCL_SKEWT_RESOURCES "<walltime>00:25:00</walltime><memory>9G</memory>">
<!ENTITY NCL_HTXS_RESOURCES "<walltime>00:25:00</walltime><memory>9G</memory>">

<!-- End gsi_hyb by 3 hr -->
<!-- End all post-processing by 6 hrs -->

<!ENTITY START_TIME_RADARLINKS "00:05:00">
<!ENTITY START_TIME_RADAR "00:15:00">
<!ENTITY START_TIME_CONVENTIONAL "00:37:00">
<!ENTITY START_TIME_GSI "01:40:00">
<!ENTITY DEADLINE_DA "03:00:00">
<!ENTITY DEADLINE_PP "06:00:00">

<!ENTITY WALL_LIMIT_DA '<deadline><cyclestr offset="&DEADLINE_DA;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_PP '<deadline><cyclestr offset="&DEADLINE_PP;">@Y@m@d@H@M</cyclestr></deadline>'>

<!ENTITY RESERVATION '<native>-l partition=&PARTITION; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account>'>
<!-- ENTITY RESERVATION_DA '<native>-l partition=&PARTITION_DA;,flags=ADVRES:&RES_DA; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT_DA;</account>' -->
<!ENTITY RESERVATION_DA '<native>-l partition=&PARTITION_DA; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT_DA;</account>'>
<!ENTITY RESERVATION_SMARTINIT '<native>-l partition=&PARTITION; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account>'>
<!-- ENTITY RESERVATION_POST '<native>-l partition=&PARTITION;,flags=ADVRES:&RES_POST; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account>' -->
<!ENTITY RESERVATION_POST '<native>-l partition=&PARTITION; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account>'>

<!-- END OF BLOCK -->

<!-- Definition Block of COMMON Variables used in all tasks -->
<!ENTITY ENVARS
   '<envar>
      <name>HOMErtma3d</name>
      <value>&HOMErtma3d;</value>
    </envar>
    <envar>
      <name>MACHINE</name>
      <value>&MACHINE;</value>
    </envar>
    <envar>
      <name>machine</name>
      <value>&machine;</value>
    </envar>'>

<!-- Definition Block of Common System Commands -->
<!ENTITY SYS_COMMANDS 
   '
   <envar>
        <name>RM</name>
        <value>/bin/rm</value>
   </envar>
   <envar>
        <name>CP</name>
        <value>/bin/cp</value>
   </envar>
   <envar>
        <name>MV</name>
        <value>/bin/mv</value>
   </envar>
   <envar>
        <name>LN</name>
        <value>/bin/ln</value>
   </envar>
   <envar>
        <name>MKDIR</name>
        <value>/bin/mkdir</value>
   </envar>
   <envar>
        <name>CAT</name>
        <value>/bin/cat</value>
   </envar>
   <envar>
        <name>ECHO</name>
        <value>/bin/echo</value>
   </envar>
   <envar>
        <name>LS</name>
        <value>/bin/ls</value>
   </envar>
   <envar>
        <name>CUT</name>
        <value>/bin/cut</value>
   </envar>
   <envar>
        <name>DATE</name>
        <value>/bin/date</value>
   </envar>
   <envar>
        <name>WC</name>
        <value>/bin/wc</value>
   </envar>
   <envar>
        <name>SED</name>
        <value>/bin/sed</value>
   </envar>
   <envar>
        <name>AWK</name>
        <value>/bin/awk --posix</value>
   </envar>
   <envar>
        <name>TAIL</name>
        <value>/bin/tail</value>
   </envar>
   <envar>
        <name>CNVGRIB</name>
        <value>cnvgrib</value>
   </envar>
   <envar>
        <name>MPIRUN</name>
        <value>mpirun</value>
   </envar>
   <envar>
        <name>CPFS</name>
        <value>cpfs</value>
   </envar>
   <envar>
        <name>UNZIP</name>
        <value>/bin/unzip</value>
   </envar>
   '>

]>

<workflow realtime="T" scheduler="moabtorque" cyclethrottle="30" cyclelifespan="01:00:00:00">

  <log>
    <cyclestr>&LOG_DIR;/workflow_@Y@m@d@H.log</cyclestr>
  </log>

  <cycledef group="00hr">00 00,12 04 04 2019 *</cycledef>
  <cycledef group="01hr">00 01,13 04 04 2019 *</cycledef>
  <cycledef group="02-11hr">00 02-11,14-23 04 04 2019 *</cycledef>

  <metatask>
    <var name="min">15 30 45 60</var>
    <var name="off">00:45:00 00:30:00 00:15:00 00:00:00</var>

  <task name="lightning_gsi_#min#" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &LIGHTNING_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;
    &SYS_COMMANDS;
    &ENVARS;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_LIGHTNING</command>
    <cores>&LIGHTNING_PROC;</cores>
    <jobname><cyclestr>HRRR_lightning_@H_#min#</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/lightning_gsi_@Y@m@d@H00_#min#.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr offset="-1:00:00">@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>SUBH_TIME</name>
      <value>#min#</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd/#min#</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/WPS</value>
    </envar>
    <envar>
      <name>LIGHTNING_ROOT</name>
      <value>&LIGHTNING_DIR;</value>
    </envar>

      <dependency>
        <or>
          <datadep><cyclestr offset="-#off#">&LIGHTNING_DIR;/vaisala/netcdf/@y@j@H@M0005r</cyclestr></datadep>
          <timedep><cyclestr offset="&START_TIME_RADAR;">@Y@m@d@H@M00</cyclestr></timedep>
        </or>
      </dependency>

  </task>
  </metatask>

  <task name="radar_links" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &RADAR_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;
    &SYS_COMMANDS;
    &ENVARS;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_RADAR_LINKS</command>
    <cores>&RADARLINKS_PROC;</cores>
    <jobname><cyclestr>HRRR_radarlinks_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/radar_links_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr offset="-01:00:00">@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>NSSL</name>
      <value>&RADAR_DIR;</value>
    </envar>

    <dependency>
      <timedep><cyclestr offset="&START_TIME_RADARLINKS;">@Y@m@d@H@M00</cyclestr></timedep>
    </dependency>

  </task>

  <metatask>
    <var name="subh">15 30 45 60</var>
    <task name="radar_gsi_#subh#" cycledefs="02-11hr,00hr,01hr" maxtries="3">

      &RADAR_RESOURCES;
      &WALL_LIMIT_DA;
      &RESERVATION;
      &SYS_COMMANDS;
      &ENVARS;

      <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_RADAR</command>
      <cores>&RADAR_PROC;</cores>
      <jobname><cyclestr>HRRR_radar_@H_#subh#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/radar_gsi_@Y@m@d@H00_#subh#.log</cyclestr></join>

      <envar>
        <name>START_TIME</name>
        <value><cyclestr offset="-01:00:00">@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>SUBH_TIME</name>
        <value>#subh#</value>
      </envar>
      <envar>
        <name>DATAROOT</name>
        <value>&DATAROOT;</value>
      </envar>
      <envar>
        <name>DATAHOME</name>
        <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd/#subh#</cyclestr></value>
      </envar>
      <envar>
        <name>GSI_ROOT</name>
        <value>&GSI_ROOT;</value>
      </envar>
      <envar>
        <name>FIX_ROOT</name>
        <value>&FIX_ROOT;</value>
      </envar>
      <envar>
        <name>STATIC_DIR</name>
        <value>&STATIC_DIR;/WPS</value>
      </envar>
      <envar>
        <name>NSSL</name>
        <value>&RADAR_DIR;</value>
      </envar>

      <dependency>
        <or>
          <datadep><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd/#subh#/filelist_mrms</cyclestr></datadep>
          <timedep><cyclestr offset="&START_TIME_RADAR;">@Y@m@d@H@M00</cyclestr></timedep>
        </or>
      </dependency>

    </task>
  </metatask>

  <task name="satellite_gsi_bufr" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &SATELLITE_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;
    &SYS_COMMANDS;
    &ENVARS;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_SATELLITE_BUFR</command>
    <cores>&SATELLITE_PROC;</cores>
    <jobname><cyclestr>HRRR_satellite_bufr_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/satellite_gsi_bufr_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/WPS</value>
    </envar>
    <envar>
      <name>NASALARC_DATA</name>
      <value>&LANGLEY_BUFR_DIR;</value>
    </envar>

    <dependency>
      <or>
        <datadep><cyclestr>&LANGLEY_BUFR_DIR;/@Y@j@H00.rap.t@Hz.lgycld.tm00.bufr_d</cyclestr></datadep>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="conventional_gsi" cycledefs="02-11hr,01hr" maxtries="3">

    &CONVENTIONAL_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;
    &SYS_COMMANDS;
    &ENVARS;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_CONVENTIONAL</command>
    <cores>&CONVENTIONAL_PROC;</cores>
    <jobname><cyclestr>HRRR_conventional_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/conventional_gsi_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>EARLY</name>
      <value>0</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>PREPBUFR</name>
      <value>&PREPBUFR_DIR;</value>
    </envar>
    <envar>
      <name>PREPBUFR_SAT</name>
      <value>&PREPBUFR_SAT_DIR;</value>
    </envar>
    <envar>
      <name>BUFRLIGHTNING</name>
      <value>&BUFRLIGHTNING_DIR;</value>
    </envar>
    <envar>
      <name>RADVELLEV2_DIR</name>
      <value>&RADVELLEV2_DIR;</value>
    </envar>
    <envar>
      <name>RADVELLEV2P5_DIR</name>
      <value>&RADVELLEV2P5_DIR;</value>
    </envar>
    <envar>
      <name>SATWND_DIR</name>
      <value>&SATWND_DIR;</value>
    </envar>
    <envar>
      <name>TAMDAR_ROOT</name>
      <value>&TAMDAR_DIR;</value>
    </envar>
    <envar>
      <name>NACELLE_RSD</name>
      <value>&NACELLE_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_RSD</name>
      <value>&TOWER_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_NRSD</name>
      <value>&TOWER_NRSD;</value>
    </envar>
    <envar>
      <name>SODAR_NRSD</name>
      <value>&SODAR_NRSD;</value>
    </envar>
    <envar>
      <name>TCVITALS_DIR</name>
      <value>&TCVITALS_DIR;</value>
    </envar>
    <envar>
      <name>STICKNET</name>
      <value>&STICKNET_DIR;</value>
    </envar>

    <dependency>
      <or>
        <and>
          <datadep><cyclestr>&PREPBUFR_DIR;/@Y@j@H00.rap.t@Hz.prepbufr.tm00.@Y@m@d</cyclestr></datadep>
          <datadep><cyclestr>&SODAR_NRSD;/@y@j@H000015o</cyclestr></datadep>
        </and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="conventional_gsi_early" cycledefs="00hr" maxtries="3">

    &CONVENTIONAL_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;
    &SYS_COMMANDS;
    &ENVARS;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_CONVENTIONAL</command>
    <cores>&CONVENTIONAL_PROC;</cores>
    <jobname><cyclestr>HRRR_conventional_early_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/conventional_gsi_early_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>EARLY</name>
      <value>1</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>PREPBUFR</name>
      <value>&PREPBUFR_DIR;</value>
    </envar>
    <envar>
      <name>PREPBUFR_SAT</name>
      <value>&PREPBUFR_SAT_DIR;</value>
    </envar>
    <envar>
      <name>BUFRLIGHTNING</name>
      <value>&BUFRLIGHTNING_DIR;</value>
    </envar>
    <envar>
      <name>RADVELLEV2_DIR</name>
      <value>&RADVELLEV2_DIR;</value>
    </envar>
    <envar>
      <name>RADVELLEV2P5_DIR</name>
      <value>&RADVELLEV2P5_DIR;</value>
    </envar>
    <envar>
      <name>SATWND_DIR</name>
      <value>&SATWND_DIR;</value>
    </envar>
    <envar>
      <name>TAMDAR_ROOT</name>
      <value>&TAMDAR_DIR;</value>
    </envar>
    <envar>
      <name>NACELLE_RSD</name>
      <value>&NACELLE_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_RSD</name>
      <value>&TOWER_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_NRSD</name>
      <value>&TOWER_NRSD;</value>
    </envar>
    <envar>
      <name>SODAR_NRSD</name>
      <value>&SODAR_NRSD;</value>
    </envar>
    <envar>
      <name>TCVITALS_DIR</name>
      <value>&TCVITALS_DIR;</value>
    </envar>
    <envar>
      <name>STICKNET</name>
      <value>&STICKNET_DIR;</value>
    </envar>

    <dependency>
      <or>
        <and>
          <datadep><cyclestr>&PREPBUFR_DIR;/@Y@j@H00.rap_e.t@Hz.prepbufr.tm00.@Y@m@d</cyclestr></datadep>
          <datadep><cyclestr>&SODAR_NRSD;/@y@j@H000015o</cyclestr></datadep>
        </and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="gsi_hyb" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &GSI_HYB_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION_DA;
    &SYS_COMMANDS;
    &ENVARS;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_GSI_HYB</command>
    <cores>&GSI_HYB_PROC;</cores>
    <jobname><cyclestr>HRRR_gsi_hyb_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/gsi_hyb_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>SYSTEM_ID</name>
      <value>&SYSTEM_ID;</value>
    </envar>
    <envar>
      <name>GSIPROC</name>
      <value>&GSI_HYB_PROC;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FULLCYC</name>
      <value>1</value>
    </envar>
    <envar>
      <name>DATABASE_DIR</name>
      <value>&DATABASE_DIR;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME_BK</name>
      <value><cyclestr offset="-1:00:00">&HRRR_DIR;/@Y@m@d@H/wrfprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/gsiprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAOBSHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;</value>
    </envar>
    <envar>
      <name>AIRCRAFT_REJECT</name>
      <value>&AIRCRAFT_REJECT;</value>
    </envar>
    <envar>
      <name>SFCOBS_USELIST</name>
      <value>&SFCOBS_USELIST;</value>
    </envar>
    <envar>
      <name>PREPBUFR</name>
      <value>&PREPBUFR_DIR;</value>
    </envar>
    <envar>
      <name>NCEPSNOW</name>
      <value>&NCEPSNOW_DIR;</value>
    </envar>
    <envar>
      <name>SST_ROOT</name>
      <value>&HIGHRES_SST_DIR;</value>
    </envar>
    <envar>
      <name>SST_ROOT14km</name>
      <value>&HIGHRES_SST14KM_DIR;</value>
    </envar>
    <envar>
      <name>ENKF_FCST</name>
      <value>&ENKFFCST_DIR;</value>
    </envar>

    <dependency>
      <and>
          <datadep>&HRRR_DIR;/<cyclestr offset="-1:00:00">@Y@m@d@H</cyclestr>/wrfprd/<cyclestr>wrfout_d01_@Y-@m-@d_@H_00_00</cyclestr></datadep>
        <or> 
          <and>
            <datadep age="00:02:00"><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd/NSSLRefInGSI.bufr</cyclestr></datadep>
            <taskdep task="lightning_gsi_15"/>
            <taskdep task="lightning_gsi_30"/>
            <taskdep task="lightning_gsi_45"/>
            <taskdep task="lightning_gsi_60"/>
            <taskdep task="satellite_gsi_bufr"/>
            <or>
              <taskdep task="conventional_gsi"/>
              <taskdep task="conventional_gsi_early"/>
            </or>
          </and>
          <timedep><cyclestr offset="&START_TIME_GSI;">@Y@m@d@H@M00</cyclestr></timedep>
        </or>
      </and>
    </dependency>

  </task>

  <task name="gsi_diag" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &GSI_DIAG_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;
    &SYS_COMMANDS;
    &ENVARS;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_GSI_DIAG</command>
    <cores>&GSI_DIAG_PROC;</cores>
    <jobname><cyclestr>gsi_diag_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/gsi_diag_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>GSIPROC</name>
      <value>&GSI_DIAG_PROC;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATABASE_DIR</name>
      <value>&DATABASE_DIR;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>

    <dependency>
      <taskdep task="gsi_hyb"/>
    </dependency>

  </task>

  <task name="post_00" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &POST_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;
    &SYS_COMMANDS;
    &ENVARS;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_UNIPOST</command>
    <cores>&POST_PROC;</cores>
    <jobname><cyclestr>HRRR_post_@H_00</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/post_@Y@m@d@H00_00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>STATICWRF_DIR</name>
      <value>&STATIC_DIR;/WRF</value>
    </envar>
    <envar>
      <name>WRF_ROOT</name>
      <value>&WRF_ROOT;</value>
    </envar>
    <envar>
      <name>EXE_ROOT</name>
      <value>&UNIPOST_EXEC;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/postprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAWRFHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/gsiprd</cyclestr></value>
    </envar>
    <envar>
      <name>MODEL</name>
      <value>RAP</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/UPP</value>
    </envar>
    <envar>
      <name>POST_NAME</name>
      <value>&POST_NAME;</value>
    </envar>

    <dependency>
      <taskdep task="gsi_hyb"/>
    </dependency>

  </task>


</workflow>

