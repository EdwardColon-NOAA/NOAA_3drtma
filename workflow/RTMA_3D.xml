<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE workflow [

<!ENTITY ACCOUNT "nrtrr">
<!ENTITY ACCOUNT_DA "nrtrr">

<!ENTITY PARTITION "xjet:vjet:sjet:ujet:tjet">
<!ENTITY PARTITION_DA "xjet:vjet:sjet:ujet:tjet">
<!ENTITY RES_DA "vjet">
<!ENTITY QUEUE "batch">

<!ENTITY HOMEBASE_DIR "/home/rtrr/RTMA_3D">
<!ENTITY DATABASE_DIR "/home/rtrr/rtma_3d_databasedir">
<!ENTITY OBS_DIR "/public/data">
<!ENTITY NCL_VER "6.3.0">

<!ENTITY SCRIPTS "&HOMEBASE_DIR;/bin">
<!ENTITY STATIC_DIR "&HOMEBASE_DIR;/static">

<!ENTITY WPS_ROOT "&HOMEBASE_DIR;/exec/WPS">
<!ENTITY WRF_ROOT "&HOMEBASE_DIR;/exec/WRF">
<!ENTITY UNIPOST_EXEC "&HOMEBASE_DIR;/exec/UPP">
<!ENTITY WGRIB1 "&HOMEBASE_DIR;/exec/UPP/wgrib">
<!ENTITY WGRIB "&HOMEBASE_DIR;/exec/UPP/wgrib2">
<!ENTITY GSI_ROOT "&HOMEBASE_DIR;/exec/GSI">
<!ENTITY FIX_ROOT "&STATIC_DIR;/GSI">

<!ENTITY HRRR_DIR "/home/rtrr/hrrr">
<!ENTITY SST_DIR "&OBS_DIR;/grids/ncep/sst/0p083deg/grib2">

<!ENTITY GFS_DIR "&OBS_DIR;/grids/gfs/0p5deg/grib2">
<!ENTITY ENKFFCST_DIR "&DATABASE_DIR;/run/gfsenkf">

<!ENTITY AIRCRAFT_REJECT "/home/rtruc/amdar_reject_lists">
<!ENTITY SFCOBS_USELIST "/lfs3/projects/amb-verif/mesonet_uselists">
<!ENTITY PREPBUFR_DIR "&OBS_DIR;/grids/rap/prepbufr">
<!ENTITY PREPBUFR_EARLY_DIR "&OBS_DIR;/grids/rap/prepbufr_test">
<!ENTITY PREPBUFR_SAT_DIR "&OBS_DIR;/grids/rap/radiance">
<!ENTITY LIGHTNING_DIR "&OBS_DIR;/lightning">
<!ENTITY RADAR_DIR "&OBS_DIR;/radar/nssl/mrms_binary">
<!ENTITY SATELLITE_DIR "&OBS_DIR;/sat/nasa">
<!ENTITY LANGLEY_BUFR_DIR "&OBS_DIR;/grids/rap/langley">
<!ENTITY NACELLE_RSD "&OBS_DIR;/tower/restricted/nacelle/netcdf">
<!ENTITY TOWER_RSD "&OBS_DIR;/tower/restricted/met/netcdf">
<!ENTITY TOWER_NRSD "&OBS_DIR;/tower/public/netcdf">
<!ENTITY SODAR_NRSD "&OBS_DIR;/profiler/wind/external/netcdf">
<!ENTITY NCEPSNOW_DIR "&OBS_DIR;/grids/ncep/snow/ims96/grib2">
<!ENTITY SST_DIR "&OBS_DIR;/grids/ncep/sst/grib2">
<!ENTITY HIGHRES_SST_DIR "&OBS_DIR;/grids/ncep/sst/0p083deg/grib2">
<!ENTITY HIGHRES_SST14KM_DIR "&OBS_DIR;/grids/ncep/sst/grib">

<!ENTITY LOG_DIR "&DATABASE_DIR;/log">
<!ENTITY DATAROOT "&DATABASE_DIR;/run">
<!ENTITY DATAROOT_BDY "&DATABASE_DIR;/run">
<!ENTITY DATAROOT_PCYC "&DATABASE_DIR;/run">

<!ENTITY MOSAIC_TILE_NUM "4">

<!ENTITY CONVENTIONAL_PROC "1">
<!ENTITY LIGHTNING_PROC "1">
<!ENTITY RADAR_PROC "4">
<!ENTITY SATELLITE_PROC "1">
<!ENTITY GSI_HYB_PROC "184">
<!ENTITY GSI_DIAG_PROC "1">

<!ENTITY POST_PROC "32">
<!ENTITY NCL_PROC "1">
<!ENTITY NCL_MAIN_PROC "8">

<!ENTITY LIGHTNING_RESOURCES "<walltime>00:05:00</walltime><memory>4G</memory>">
<!ENTITY CONVENTIONAL_RESOURCES "<walltime>00:05:00</walltime><memory>2G</memory>">
<!ENTITY RADAR_RESOURCES "<walltime>00:05:00</walltime>">
<!ENTITY SATELLITE_RESOURCES "<walltime>00:05:00</walltime><memory>10G</memory>">
<!ENTITY GSI_HYB_RESOURCES "<walltime>00:40:00</walltime>">
<!ENTITY GSI_DIAG_RESOURCES "<walltime>00:05:00</walltime><memory>600M</memory>">
<!ENTITY POST_RESOURCES "<walltime>00:45:00</walltime>">
<!ENTITY NCL_RESOURCES "<walltime>00:55:00</walltime>">
<!ENTITY NCL_SKEWT_RESOURCES "<walltime>00:25:00</walltime><memory>9G</memory>">
<!ENTITY NCL_HTXS_RESOURCES "<walltime>00:25:00</walltime><memory>9G</memory>">

<!-- Start WRF at 90 min (1 hr 30 min) -->
<!-- End WRF at 150 min (2 hr 30 min) -->
<!-- End all post-processing by 195 min (3 hrs 15 min) -->

<!ENTITY START_TIME_RADAR "00:15:00">
<!ENTITY START_TIME_CONVENTIONAL "00:37:00">
<!ENTITY START_TIME_GSI "00:40:00">
<!ENTITY DEADLINE_DA "01:30:00">
<!ENTITY DEADLINE_PP "03:15:00">

<!ENTITY WALL_LIMIT_DA '<deadline><cyclestr offset="&DEADLINE_DA;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_WRF '<deadline><cyclestr offset="&DEADLINE_WRF;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_PP '<deadline><cyclestr offset="&DEADLINE_PP;">@Y@m@d@H@M</cyclestr></deadline>'>

<!ENTITY RESERVATION '<native>-l partition=&PARTITION; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account>'>
<!ENTITY RESERVATION_DA '<native>-l partition=&PARTITION_DA; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT_DA;</account>'>

]>

<workflow realtime="T" scheduler="moabtorque" cyclethrottle="30" cyclelifespan="01:00:00:00">

  <log>
    <cyclestr>&LOG_DIR;/workflow_@Y@m@d@H.log</cyclestr>
  </log>

  <cycledef group="01hr">00 02-11,14-23 * * 2015-2020 *</cycledef>
  <cycledef group="12hr">00 00,12 * * 2015-2020 *</cycledef>
  <cycledef group="13hr">00 01,13 * * 2015-2020 *</cycledef>

  <task name="lightning_gsi" cycledefs="01hr,12hr,13hr" maxtries="3">

    &LIGHTNING_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/lightning.ksh</command>
    <cores>&LIGHTNING_PROC;</cores>
    <jobname><cyclestr>HRRR_lightning_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/lightning_gsi_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>PRESTART_TIME</name>
      <value><cyclestr offset="-1:00:00">@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/WPS</value>
    </envar>
    <envar>
      <name>LIGHTNING_ROOT</name>
      <value>&LIGHTNING_DIR;</value>
    </envar>

    <dependency>
      <or>
        <and>
          <datadep><cyclestr>&LIGHTNING_DIR;/gld360/netcdf/@y@j@H050005r</cyclestr></datadep>
          <datadep><cyclestr>&LIGHTNING_DIR;/gld360/netcdf/@y@j@H000005r</cyclestr></datadep>
          <datadep><cyclestr offset="-1:00:00">&LIGHTNING_DIR;/gld360/netcdf/@y@j@H550005r</cyclestr></datadep>
          <datadep><cyclestr offset="-1:00:00">&LIGHTNING_DIR;/gld360/netcdf/@y@j@H500005r</cyclestr></datadep>
          <datadep><cyclestr offset="-1:00:00">&LIGHTNING_DIR;/gld360/netcdf/@y@j@H450005r</cyclestr></datadep>
          <datadep><cyclestr offset="-1:00:00">&LIGHTNING_DIR;/gld360/netcdf/@y@j@H400005r</cyclestr></datadep>
          <datadep><cyclestr offset="-1:00:00">&LIGHTNING_DIR;/gld360/netcdf/@y@j@H350005r</cyclestr></datadep>
          <datadep><cyclestr>&LIGHTNING_DIR;/alaska/ascii/@Y@m@d@H0100</cyclestr></datadep>
          <datadep><cyclestr>&LIGHTNING_DIR;/alaska/ascii/@Y@m@d@H0101</cyclestr></datadep>
        </and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="radar_gsi" cycledefs="01hr,12hr,13hr" maxtries="3">

    &RADAR_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/radar.ksh</command>
    <cores>&RADAR_PROC;</cores>
    <jobname><cyclestr>HRRR_radar_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/radar_gsi_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>SUBH_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/WPS</value>
    </envar>
    <envar>
      <name>NSSLMOSAICNC</name>
      <value>&RADAR_DIR;</value>
    </envar>
    <envar>
      <name>MOSAICTILENUM</name>
      <value>&MOSAIC_TILE_NUM;</value>
    </envar>

    <dependency>
      <or>
        <and>
          <datadep><cyclestr>&RADAR_DIR;/tile1/mrefl/MREF3D33L.@Y@m@d.@H0000.gz</cyclestr></datadep>
          <datadep><cyclestr>&RADAR_DIR;/tile2/mrefl/MREF3D33L.@Y@m@d.@H0000.gz</cyclestr></datadep>
          <datadep><cyclestr>&RADAR_DIR;/tile3/mrefl/MREF3D33L.@Y@m@d.@H0000.gz</cyclestr></datadep>
          <datadep><cyclestr>&RADAR_DIR;/tile4/mrefl/MREF3D33L.@Y@m@d.@H0000.gz</cyclestr></datadep>
        </and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="satellite_gsi" cycledefs="01hr,12hr,13hr" maxtries="3">

    &SATELLITE_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/satellite.ksh</command>
    <cores>&SATELLITE_PROC;</cores>
    <jobname><cyclestr>HRRR_satellite_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/satellite_gsi_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/WPS</value>
    </envar>
    <envar>
      <name>NASALARC_DATA</name>
      <value>&SATELLITE_DIR;</value>
    </envar>

    <dependency>
      <or>
        <and>
          <datadep><cyclestr offset="-1:00:00">&SATELLITE_DIR;/goes-west/visst/rr/netcdf/G15V3.0.RR.@Y@j.@H30.PX.08K.CDF</cyclestr></datadep>
          <datadep><cyclestr offset="-1:00:00">&SATELLITE_DIR;/goes-east/visst/rr/netcdf/G16V3.0.RR.@Y@j.@H45.PX.06K.CDF</cyclestr></datadep>
        </and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="satellite_gsi_bufr" cycledefs="01hr,12hr,13hr" maxtries="3">

    &SATELLITE_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/satellite_bufr.ksh</command>
    <cores>&SATELLITE_PROC;</cores>
    <jobname><cyclestr>HRRR_satellite_bufr_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/satellite_gsi_bufr_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/WPS</value>
    </envar>
    <envar>
      <name>NASALARC_DATA</name>
      <value>&LANGLEY_BUFR_DIR;</value>
    </envar>

    <dependency>
          <datadep><cyclestr>&LANGLEY_BUFR_DIR;/@Y@j@H00.rap.t@Hz.lgycld.tm00.bufr_d</cyclestr></datadep>
    </dependency>

  </task>

  <task name="conventional_gsi" cycledefs="01hr,13hr" maxtries="3">

    &CONVENTIONAL_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/conventional.ksh</command>
    <cores>&CONVENTIONAL_PROC;</cores>
    <jobname><cyclestr>HRRR_conventional_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/conventional_gsi_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>EARLY</name>
      <value>0</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>PREPBUFR</name>
      <value>&PREPBUFR_DIR;</value>
    </envar>
    <envar>
      <name>PREPBUFR_SAT</name>
      <value>&PREPBUFR_SAT_DIR;</value>
    </envar>
    <envar>
      <name>NACELLE_RSD</name>
      <value>&NACELLE_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_RSD</name>
      <value>&TOWER_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_NRSD</name>
      <value>&TOWER_NRSD;</value>
    </envar>
    <envar>
      <name>SODAR_NRSD</name>
      <value>&SODAR_NRSD;</value>
    </envar>

    <dependency>
      <or>
        <and>
          <datadep><cyclestr>&PREPBUFR_EARLY_DIR;/@Y@j@H00.rap.t@Hz.prepbufr.tm00.@Y@m@d.test</cyclestr></datadep>
          <datadep><cyclestr>&NACELLE_RSD;/@y@j@H000010o</cyclestr></datadep>
          <datadep><cyclestr>&TOWER_RSD;/@y@j@H000010o</cyclestr></datadep>
          <datadep><cyclestr>&TOWER_NRSD;/@y@j@H000100o</cyclestr></datadep>
          <datadep><cyclestr>&SODAR_NRSD;/@y@j@H000015o</cyclestr></datadep>
        </and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="conventional_gsi_early" cycledefs="12hr" maxtries="3">

    &CONVENTIONAL_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/conventional.ksh</command>
    <cores>&CONVENTIONAL_PROC;</cores>
    <jobname><cyclestr>HRRR_conventional_early_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/conventional_gsi_early_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>EARLY</name>
      <value>1</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>PREPBUFR</name>
      <value>&PREPBUFR_DIR;</value>
    </envar>
    <envar>
      <name>PREPBUFR_SAT</name>
      <value>&PREPBUFR_SAT_DIR;</value>
    </envar>
    <envar>
      <name>NACELLE_RSD</name>
      <value>&NACELLE_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_RSD</name>
      <value>&TOWER_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_NRSD</name>
      <value>&TOWER_NRSD;</value>
    </envar>
    <envar>
      <name>SODAR_NRSD</name>
      <value>&SODAR_NRSD;</value>
    </envar>

    <dependency>
      <or>
        <and>
          <datadep><cyclestr>&PREPBUFR_EARLY_DIR;/@Y@j@H00.rap_e.t@Hz.prepbufr.tm00.@Y@m@d.test</cyclestr></datadep>
          <datadep><cyclestr>&NACELLE_RSD;/@y@j@H000010o</cyclestr></datadep>
          <datadep><cyclestr>&TOWER_RSD;/@y@j@H000010o</cyclestr></datadep>
          <datadep><cyclestr>&TOWER_NRSD;/@y@j@H000100o</cyclestr></datadep>
          <datadep><cyclestr>&SODAR_NRSD;/@y@j@H000015o</cyclestr></datadep>
        </and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="gsi_hyb" cycledefs="01hr,12hr,13hr" maxtries="3">

    &GSI_HYB_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION_DA;

    <command>&SCRIPTS;/GSI/gsi_hyb.ksh</command>
    <cores>&GSI_HYB_PROC;</cores>
    <jobname><cyclestr>HRRR_gsi_hyb_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/gsi_hyb_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>GSIPROC</name>
      <value>&GSI_HYB_PROC;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FULLCYC</name>
      <value>1</value>
    </envar>
    <envar>
      <name>DATABASE_DIR</name>
      <value>&DATABASE_DIR;</value>
    </envar>
    <envar>
      <name>DATAHOME_BK</name>
      <value><cyclestr offset="-1:00:00">&HRRR_DIR;/@Y@m@d@H/wrfprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/gsiprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAOBSHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;</value>
    </envar>
    <envar>
      <name>AIRCRAFT_REJECT</name>
      <value>&AIRCRAFT_REJECT;</value>
    </envar>
    <envar>
      <name>SFCOBS_USELIST</name>
      <value>&SFCOBS_USELIST;</value>
    </envar>
    <envar>
      <name>PREPBUFR</name>
      <value>&PREPBUFR_SAT_DIR;</value>
    </envar>
    <envar>
      <name>NCEPSNOW</name>
      <value>&NCEPSNOW_DIR;</value>
    </envar>
    <envar>
      <name>SST_ROOT</name>
      <value>&HIGHRES_SST_DIR;</value>
    </envar>
    <envar>
      <name>SST_ROOT14km</name>
      <value>&HIGHRES_SST14KM_DIR;</value>
    </envar>
    <envar>
      <name>ENKF_FCST</name>
      <value>&ENKFFCST_DIR;</value>
    </envar>

    <dependency>
      <and>
          <datadep>&HRRR_DIR;/<cyclestr offset="-1:00:00">@Y@m@d@H</cyclestr>/wrfprd/<cyclestr>wrfout_d01_@Y-@m-@d_@H_00_00</cyclestr></datadep>
        <or> 
          <and>
            <taskdep task="lightning_gsi"/>
            <taskdep task="radar_gsi"/>
            <taskdep task="satellite_gsi_bufr"/>
            <or>
              <taskdep task="conventional_gsi"/>
              <taskdep task="conventional_gsi_early"/>
            </or>
          </and>
          <timedep><cyclestr offset="&START_TIME_GSI;">@Y@m@d@H@M00</cyclestr></timedep>
        </or>
      </and>
    </dependency>

  </task>

  <task name="gsi_diag" cycledefs="01hr,12hr,13hr" maxtries="3">

    &GSI_DIAG_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/gsi_diag.ksh</command>
    <cores>&GSI_DIAG_PROC;</cores>
    <jobname><cyclestr>gsi_diag_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/gsi_diag_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>GSIPROC</name>
      <value>&GSI_DIAG_PROC;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATABASE_DIR</name>
      <value>&DATABASE_DIR;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>

    <dependency>
      <taskdep task="gsi_hyb"/>
    </dependency>

  </task>

  <task name="post_00" cycledefs="01hr,12hr,13hr" maxtries="3">

    &POST_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/UPP/unipost.ksh</command>
    <cores>&POST_PROC;</cores>
    <jobname><cyclestr>HRRR_post_@H_00</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/post_@Y@m@d@H00_00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>STATICWRF_DIR</name>
      <value>&STATIC_DIR;/WRF</value>
    </envar>
    <envar>
      <name>WRF_ROOT</name>
      <value>&WRF_ROOT;</value>
    </envar>
    <envar>
      <name>EXE_ROOT</name>
      <value>&UNIPOST_EXEC;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/postprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAWRFHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/gsiprd</cyclestr></value>
    </envar>
    <envar>
      <name>MODEL</name>
      <value>RAP</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/UPP</value>
    </envar>

    <dependency>
      <taskdep task="gsi_hyb"/>
    </dependency>

  </task>

  <task name="ncl_00" cycledefs="01hr,12hr,13hr" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr.ksh</command>
    <cores>&NCL_MAIN_PROC;</cores>
    <jobname><cyclestr>HRRR_ncl_@H_00</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>NCL_VER</name>
      <value>&NCL_VER;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MODEL</name>
      <value>RTMA_3D</value>
    </envar>

    <dependency>
      <taskdep task="post_00"/>
    </dependency>

  </task>

  <metatask>
    <var name="skewt">skewt1 skewt2 skewt3 skewt4 skewt5</var>

    <task name="ncl_00_#skewt#" cycledefs="01hr,12hr,13hr" maxtries="3">

      &NCL_SKEWT_RESOURCES;
      &WALL_LIMIT_PP;
      &RESERVATION;

      <command>&SCRIPTS;/NCL/ncl_hrrr_#skewt#.ksh</command>
      <cores>&NCL_PROC;</cores>
      <jobname><cyclestr>HRRR_ncl_@H_00_#skewt#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_00_#skewt#.log</cyclestr></join>

      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>FCST_TIME</name>
        <value>00</value>
      </envar>
      <envar>
        <name>NCL_VER</name>
        <value>&NCL_VER;</value>
      </envar>
      <envar>
        <name>DATAROOT</name>
        <value>&DATAROOT;</value>
      </envar>
      <envar>
        <name>DATAHOME</name>
        <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MODEL</name>
        <value>RTMA_3D</value>
      </envar>

      <dependency>
        <taskdep task="post_00"/>
      </dependency>

    </task>

  </metatask>

  <metatask>
    <var name="htxs">htxs1</var>

    <task name="ncl_00_#htxs#" cycledefs="01hr,12hr,13hr" maxtries="3">

      &NCL_HTXS_RESOURCES;
      &WALL_LIMIT_PP;
      &RESERVATION;

      <command>&SCRIPTS;/NCL/ncl_hrrr_#htxs#.ksh</command>
      <cores>&NCL_PROC;</cores>
      <jobname><cyclestr>HRRR_ncl_@H_00_#htxs#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_00_#htxs#.log</cyclestr></join>

      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>FCST_TIME</name>
        <value>00</value>
      </envar>
      <envar>
        <name>NCL_VER</name>
        <value>&NCL_VER;</value>
      </envar>
      <envar>
        <name>DATAROOT</name>
        <value>&DATAROOT;</value>
      </envar>
      <envar>
        <name>DATAHOME</name>
        <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MODEL</name>
        <value>RTMA_3D</value>
      </envar>

      <dependency>
        <taskdep task="post_00"/>
      </dependency>

    </task>

  </metatask>

  <task name="ncl_zip" cycledefs="01hr,12hr,13hr" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr_zip.ksh</command>
    <cores>&NCL_PROC;</cores>
    <jobname><cyclestr>HRRR_ncl_@H_zip</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_zip.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
      <or>
        <taskdep task="ncl_00"/>
        <timedep><cyclestr offset="03:00:00">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>
    
  </task>

  <task name="ncl_skewt_zip" cycledefs="01hr,12hr,13hr" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr_skewt_zip.ksh</command>
    <cores>&NCL_PROC;</cores>
    <jobname><cyclestr>HRRR_ncl_@H_skewt_zip</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_skewt_zip.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
      <or>
        <and>
          <taskdep task="ncl_00_skewt1"/>
          <taskdep task="ncl_00_skewt2"/>
          <taskdep task="ncl_00_skewt3"/>
          <taskdep task="ncl_00_skewt4"/>
          <taskdep task="ncl_00_skewt5"/>
        </and>
        <timedep><cyclestr offset="03:00:00">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>
    
  </task>

  <task name="ncl_htxs_zip" cycledefs="01hr,12hr,13hr" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr_htxs_zip.ksh</command>
    <cores>&NCL_PROC;</cores>
    <jobname><cyclestr>HRRR_ncl_@H_htxs_zip</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_htxs_zip.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
      <or>
        <and>
          <taskdep task="ncl_00_htxs1"/>
        </and>
        <timedep><cyclestr offset="02:55:00">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>
    
  </task>

</workflow>
