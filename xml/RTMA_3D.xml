<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE workflow [

<!-- ENTITY ACCOUNT "rtrr" -->
<!ENTITY ACCOUNT "hfv3gfs">
<!-- ENTITY ACCOUNT_DA "rtrr" -->
<!ENTITY ACCOUNT_DA "hfv3gfs">

<!-- ENTITY PARTITION "kjet" -->
<!ENTITY PARTITION "xjet:vjet:sjet:tjet">
<!ENTITY PARTITION_DA "kjet">
<!ENTITY QUEUE "batch">
<!ENTITY RES_DA "rtma-kjet">
<!ENTITY RES_POST "rtma-kjet">

<!ENTITY SYSTEM_ID "RTMA_3D"> 
<!-- ENTITY HOMEBASE_DIR "/home/rtrr/RTMA_3D_dev1" -->
<!ENTITY HOMEBASE_DIR "/home/Gang.Zhao/rtma3d_repo/GSD_dev1_test">
<!-- ENTITY DATABASE_DIR "/home/rtrr/rtma_3d_dev1_databasedir" -->
<!ENTITY DATABASE_DIR "/mnt/lfs3/projects/hfv3gfs/Gang.Zhao/gsd_dev1_databasedir">
<!ENTITY OBS_DIR "/public/data">
<!ENTITY NCL_VER "6.3.0">
<!ENTITY JOBNAME_PRE "RTMA3D_dev1">

<!ENTITY SCRIPTS "&HOMEBASE_DIR;/bin">
<!ENTITY STATIC_DIR "&HOMEBASE_DIR;/static">

<!ENTITY WPS_ROOT "&HOMEBASE_DIR;/exec/WPS">
<!ENTITY WRF_ROOT "&HOMEBASE_DIR;/exec/WRF">
<!ENTITY UNIPOST_EXEC "&HOMEBASE_DIR;/exec/UPP">
<!ENTITY SMARTINIT_EXEC "&HOMEBASE_DIR;/exec/smartinit"> 
<!ENTITY WGRIB1 "&HOMEBASE_DIR;/exec/UPP/wgrib">
<!ENTITY WGRIB "&HOMEBASE_DIR;/exec/UPP/wgrib2">
<!ENTITY GSI_ROOT "&HOMEBASE_DIR;/exec/GSI">
<!ENTITY FIX_ROOT "&STATIC_DIR;/GSI">

<!ENTITY HRRR_DIR "/home/rtrr/hrrr">
<!ENTITY SST_DIR "&OBS_DIR;/grids/ncep/sst/0p083deg/grib2">

<!ENTITY GFS_DIR "&OBS_DIR;/grids/gfs/0p5deg/grib2">
<!ENTITY ENKFFCST_DIR "&OBS_DIR;/grids/enkf/atm">

<!ENTITY AIRCRAFT_REJECT "/home/rtruc/amdar_reject_lists">
<!ENTITY SFCOBS_USELIST "/lfs3/projects/amb-verif/mesonet_uselists">
<!ENTITY PREPBUFR_DIR "&OBS_DIR;/grids/rap/prepbufr">
<!ENTITY PREPBUFR_EARLY_DIR "&OBS_DIR;/grids/rap/prepbufr_test">
<!ENTITY PREPBUFR_SAT_DIR "&OBS_DIR;/grids/rap/radiance">
<!ENTITY LIGHTNING_DIR "&OBS_DIR;/lightning">
<!ENTITY BUFRLIGHTNING_DIR "/mnt/lfs1/projects/rtwbl/mhu/rapobs/radiance">
<!ENTITY RADAR_DIR "&OBS_DIR;/radar/mrms">
<!ENTITY SATELLITE_DIR "&OBS_DIR;/sat/nasa">
<!ENTITY LANGLEY_BUFR_DIR "&OBS_DIR;/grids/rap/langley">
<!ENTITY RADVELLEV2_DIR "&OBS_DIR;/grids/rap/nexrad">
<!ENTITY RADVELLEV2P5_DIR "&OBS_DIR;/grids/rap/radwnd">
<!ENTITY SATWND_DIR "&OBS_DIR;/grids/rap/satwnd">
<!ENTITY NACELLE_RSD "&OBS_DIR;/tower/restricted/nacelle/netcdf">
<!ENTITY TOWER_RSD "&OBS_DIR;/tower/restricted/met/netcdf">
<!ENTITY TOWER_NRSD "&OBS_DIR;/tower/public/netcdf">
<!ENTITY SODAR_NRSD "&OBS_DIR;/profiler/wind/external/netcdf">
<!ENTITY TAMDAR_DIR "&OBS_DIR;/acars/raw/netcdf">
<!ENTITY NCEPSNOW_DIR "&OBS_DIR;/grids/ncep/snow/ims96/grib2">
<!ENTITY HIGHRES_SST_DIR "&OBS_DIR;/grids/ncep/sst/0p083deg/grib2">
<!ENTITY HIGHRES_SST14KM_DIR "&OBS_DIR;/grids/ncep/sst/grib">
<!ENTITY TCVITALS_DIR "&OBS_DIR;/nhc/tcvitals">
<!ENTITY STICKNET_DIR "&OBS_DIR;/vortex-se/stesonet">

<!ENTITY LOG_DIR "&DATABASE_DIR;/log">
<!ENTITY DATAROOT_ENS "&DATABASE_DIR;/gfsenkf">
<!ENTITY DATAROOT "&DATABASE_DIR;/run">
<!ENTITY DATAROOT_BC "&DATABASE_DIR;/run">
<!ENTITY DATAROOT_PCYC "&DATABASE_DIR;/run">

<!ENTITY POST_NAME "hrconus">

<!ENTITY SMARTINIT_PROC "1">
<!ENTITY CONVENTIONAL_PROC "1">
<!ENTITY LIGHTNING_PROC "1">
<!ENTITY RADAR_PROC "33">
<!ENTITY SATELLITE_PROC "1">
<!ENTITY GSI_HYB_PROC "280">
<!ENTITY GSI_DIAG_PROC "1">
<!ENTITY RADARLINKS_PROC "1">

<!ENTITY POST_PROC "32">
<!ENTITY NCL_PROC "1">
<!ENTITY NCL_MAIN_PROC "8">
<!ENTITY CLEAN_PROC "1">

<!ENTITY SMARTINIT_RESOURCES "<walltime>00:10:00</walltime><memory>10G</memory>">
<!ENTITY CLEAN_RESOURCES "<walltime>00:45:00</walltime><memory>500M</memory>">
<!ENTITY LIGHTNING_RESOURCES "<walltime>00:05:00</walltime><memory>4G</memory>">
<!ENTITY CONVENTIONAL_RESOURCES "<walltime>00:05:00</walltime><memory>2G</memory>">
<!ENTITY RADAR_RESOURCES "<walltime>00:05:00</walltime>">
<!ENTITY SATELLITE_RESOURCES "<walltime>00:05:00</walltime><memory>10G</memory>">
<!ENTITY GSI_HYB_RESOURCES "<walltime>00:40:00</walltime>">
<!ENTITY GSI_DIAG_RESOURCES "<walltime>00:05:00</walltime><memory>600M</memory>">
<!ENTITY POST_RESOURCES "<walltime>00:45:00</walltime>">
<!ENTITY NCL_RESOURCES "<walltime>00:55:00</walltime>">
<!ENTITY NCL_SKEWT_RESOURCES "<walltime>00:25:00</walltime><memory>9G</memory>">
<!ENTITY NCL_HTXS_RESOURCES "<walltime>00:25:00</walltime><memory>9G</memory>">

<!-- End gsi_hyb by 3 hr -->
<!-- End all post-processing by 6 hrs -->

<!ENTITY START_TIME_RADARLINKS "00:05:00">
<!ENTITY START_TIME_RADAR "00:15:00">
<!ENTITY START_TIME_CONVENTIONAL "00:37:00">
<!ENTITY START_TIME_GSI "01:40:00">
<!ENTITY DEADLINE_DA "03:00:00">
<!ENTITY DEADLINE_PP "06:00:00">

<!ENTITY WALL_LIMIT_DA '<deadline><cyclestr offset="&DEADLINE_DA;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_PP '<deadline><cyclestr offset="&DEADLINE_PP;">@Y@m@d@H@M</cyclestr></deadline>'>

<!ENTITY RESERVATION '<native>-l partition=&PARTITION; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account>'>
<!-- ENTITY RESERVATION_DA '<native>-l partition=&PARTITION_DA;,flags=ADVRES:&RES_DA; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT_DA;</account>' -->
<!ENTITY RESERVATION_DA '<native>-l partition=&PARTITION_DA; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT_DA;</account>'>
<!ENTITY RESERVATION_SMARTINIT '<native>-l partition=&PARTITION; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account>'>
<!ENTITY RESERVATION_POST '<native>-l partition=&PARTITION;,flags=ADVRES:&RES_POST; -W umask=022 -m n</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account>'>

]>

<workflow realtime="T" scheduler="moabtorque" cyclethrottle="30" cyclelifespan="01:00:00:00">

  <log>
    <cyclestr>&LOG_DIR;/workflow_@Y@m@d@H.log</cyclestr>
  </log>

  <cycledef group="00hr">00 00,12 03 04 2019 *</cycledef>
  <cycledef group="01hr">00 01,13 03 04 2019 *</cycledef>
  <cycledef group="02-11hr">00 02-11,14-23 03 04 2019 *</cycledef>

  <metatask>
<!-- only need 60 for hourly running
    <var name="min">15 30 45 60</var>
    <var name="off">00:45:00 00:30:00 00:15:00 00:00:00</var>
-->
    <var name="min">60</var>
    <var name="off">00:00:00</var>

  <task name="lightning_gsi_#min#" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &LIGHTNING_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/lightning.ksh</command>
    <cores>&LIGHTNING_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_lightning_@H_#min#</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/lightning_gsi_@Y@m@d@H00_#min#.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr offset="-1:00:00">@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>SUBH_TIME</name>
      <value>#min#</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd/#min#</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/WPS</value>
    </envar>
    <envar>
      <name>LIGHTNING_ROOT</name>
      <value>&LIGHTNING_DIR;</value>
    </envar>

      <dependency>
        <or>
          <datadep><cyclestr offset="-#off#">&LIGHTNING_DIR;/vaisala/netcdf/@y@j@H@M0005r</cyclestr></datadep>
          <timedep><cyclestr offset="&START_TIME_RADAR;">@Y@m@d@H@M00</cyclestr></timedep>
        </or>
      </dependency>

  </task>
  </metatask>

  <task name="radar_links" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &RADAR_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/radar_links.ksh</command>
    <cores>&RADARLINKS_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_radarlinks_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/radar_links_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr offset="-01:00:00">@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>NSSL</name>
      <value>&RADAR_DIR;</value>
    </envar>

    <dependency>
      <timedep><cyclestr offset="&START_TIME_RADARLINKS;">@Y@m@d@H@M00</cyclestr></timedep>
    </dependency>

  </task>

  <task name="radar_gsi" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &RADAR_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION_POST;

    <command>&SCRIPTS;/GSI/radar.ksh</command>
    <cores>&RADAR_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_radar_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/radar_gsi_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>SUBH_TIME</name>
      <value>00</value>
    </envar>      
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/WPS</value>
    </envar>
    <envar>
      <name>NSSL</name>
      <value>&RADAR_DIR;</value>
    </envar>

    <dependency>
      <or>
        <datadep><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd/filelist_mrms</cyclestr></datadep>
        <timedep><cyclestr offset="&START_TIME_RADAR;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

<!-- don't need subhour radar_gsi for hourly run
  <metatask>
    <var name="subh">15 30 45 60</var>
    <task name="radar_gsi_#subh#" cycledefs="02-11hr,00hr,01hr" maxtries="3">

      &RADAR_RESOURCES;
      &WALL_LIMIT_DA;
      &RESERVATION;

      <command>&SCRIPTS;/GSI/radar.ksh</command>
      <cores>&RADAR_PROC;</cores>
      <jobname><cyclestr>&JOBNAME_PRE;_radar_@H_#subh#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/radar_gsi_@Y@m@d@H00_#subh#.log</cyclestr></join>

      <envar>
        <name>START_TIME</name>
        <value><cyclestr offset="-01:00:00">@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>SUBH_TIME</name>
        <value>#subh#</value>
      </envar>
      <envar>
        <name>DATAROOT</name>
        <value>&DATAROOT;</value>
      </envar>
      <envar>
        <name>DATAHOME</name>
        <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd/#subh#</cyclestr></value>
      </envar>
      <envar>
        <name>GSI_ROOT</name>
        <value>&GSI_ROOT;</value>
      </envar>
      <envar>
        <name>FIX_ROOT</name>
        <value>&FIX_ROOT;</value>
      </envar>
      <envar>
        <name>STATIC_DIR</name>
        <value>&STATIC_DIR;/WPS</value>
      </envar>
      <envar>
        <name>NSSL</name>
        <value>&RADAR_DIR;</value>
      </envar>

      <dependency>
        <or>
          <datadep><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd/#subh#/filelist_mrms</cyclestr></datadep>
          <timedep><cyclestr offset="&START_TIME_RADAR;">@Y@m@d@H@M00</cyclestr></timedep>
        </or>
      </dependency>

    </task>
  </metatask>
-->

  <task name="satellite_gsi_bufr" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &SATELLITE_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/satellite_bufr.ksh</command>
    <cores>&SATELLITE_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_satellite_bufr_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/satellite_gsi_bufr_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/WPS</value>
    </envar>
    <envar>
      <name>NASALARC_DATA</name>
      <value>&LANGLEY_BUFR_DIR;</value>
    </envar>

    <dependency>
      <or>
        <datadep><cyclestr>&LANGLEY_BUFR_DIR;/@Y@j@H00.rap.t@Hz.lgycld.tm00.bufr_d</cyclestr></datadep>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="conventional_gsi" cycledefs="02-11hr,01hr" maxtries="3">

    &CONVENTIONAL_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/conventional.ksh</command>
    <cores>&CONVENTIONAL_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_conventional_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/conventional_gsi_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>EARLY</name>
      <value>0</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>PREPBUFR</name>
      <value>&PREPBUFR_DIR;</value>
    </envar>
    <envar>
      <name>PREPBUFR_SAT</name>
      <value>&PREPBUFR_SAT_DIR;</value>
    </envar>
    <envar>
      <name>BUFRLIGHTNING</name>
      <value>&BUFRLIGHTNING_DIR;</value>
    </envar>
    <envar>
      <name>RADVELLEV2_DIR</name>
      <value>&RADVELLEV2_DIR;</value>
    </envar>
    <envar>
      <name>RADVELLEV2P5_DIR</name>
      <value>&RADVELLEV2P5_DIR;</value>
    </envar>
    <envar>
      <name>SATWND_DIR</name>
      <value>&SATWND_DIR;</value>
    </envar>
    <envar>
      <name>TAMDAR_ROOT</name>
      <value>&TAMDAR_DIR;</value>
    </envar>
    <envar>
      <name>NACELLE_RSD</name>
      <value>&NACELLE_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_RSD</name>
      <value>&TOWER_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_NRSD</name>
      <value>&TOWER_NRSD;</value>
    </envar>
    <envar>
      <name>SODAR_NRSD</name>
      <value>&SODAR_NRSD;</value>
    </envar>
    <envar>
      <name>TCVITALS_DIR</name>
      <value>&TCVITALS_DIR;</value>
    </envar>
    <envar>
      <name>STICKNET</name>
      <value>&STICKNET_DIR;</value>
    </envar>

    <dependency>
      <or>
        <and>
          <datadep><cyclestr>&PREPBUFR_DIR;/@Y@j@H00.rap.t@Hz.prepbufr.tm00.@Y@m@d</cyclestr></datadep>
          <datadep><cyclestr>&SODAR_NRSD;/@y@j@H000015o</cyclestr></datadep>
        </and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="conventional_gsi_early" cycledefs="00hr" maxtries="3">

    &CONVENTIONAL_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/conventional.ksh</command>
    <cores>&CONVENTIONAL_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_conventional_early_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/conventional_gsi_early_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>EARLY</name>
      <value>1</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>PREPBUFR</name>
      <value>&PREPBUFR_DIR;</value>
    </envar>
    <envar>
      <name>PREPBUFR_SAT</name>
      <value>&PREPBUFR_SAT_DIR;</value>
    </envar>
    <envar>
      <name>BUFRLIGHTNING</name>
      <value>&BUFRLIGHTNING_DIR;</value>
    </envar>
    <envar>
      <name>RADVELLEV2_DIR</name>
      <value>&RADVELLEV2_DIR;</value>
    </envar>
    <envar>
      <name>RADVELLEV2P5_DIR</name>
      <value>&RADVELLEV2P5_DIR;</value>
    </envar>
    <envar>
      <name>SATWND_DIR</name>
      <value>&SATWND_DIR;</value>
    </envar>
    <envar>
      <name>TAMDAR_ROOT</name>
      <value>&TAMDAR_DIR;</value>
    </envar>
    <envar>
      <name>NACELLE_RSD</name>
      <value>&NACELLE_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_RSD</name>
      <value>&TOWER_RSD;</value>
    </envar>
    <envar>
      <name>TOWER_NRSD</name>
      <value>&TOWER_NRSD;</value>
    </envar>
    <envar>
      <name>SODAR_NRSD</name>
      <value>&SODAR_NRSD;</value>
    </envar>
    <envar>
      <name>TCVITALS_DIR</name>
      <value>&TCVITALS_DIR;</value>
    </envar>
    <envar>
      <name>STICKNET</name>
      <value>&STICKNET_DIR;</value>
    </envar>

    <dependency>
      <or>
        <and>
          <datadep><cyclestr>&PREPBUFR_DIR;/@Y@j@H00.rap_e.t@Hz.prepbufr.tm00.@Y@m@d</cyclestr></datadep>
          <datadep><cyclestr>&SODAR_NRSD;/@y@j@H000015o</cyclestr></datadep>
        </and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="gsi_hyb" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &GSI_HYB_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION_DA;

    <command>&SCRIPTS;/GSI/gsi_hyb.ksh</command>
    <cores>&GSI_HYB_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_gsi_hyb_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/gsi_hyb_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>SYSTEM_ID</name>
      <value>&SYSTEM_ID;</value>
    </envar>
    <envar>
      <name>GSIPROC</name>
      <value>&GSI_HYB_PROC;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FULLCYC</name>
      <value>1</value>
    </envar>
    <envar>
      <name>DATABASE_DIR</name>
      <value>&DATABASE_DIR;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME_BK</name>
      <value><cyclestr offset="-1:00:00">&HRRR_DIR;/@Y@m@d@H/wrfprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/gsiprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAOBSHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>FIX_ROOT</name>
      <value>&FIX_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;</value>
    </envar>
    <envar>
      <name>AIRCRAFT_REJECT</name>
      <value>&AIRCRAFT_REJECT;</value>
    </envar>
    <envar>
      <name>SFCOBS_USELIST</name>
      <value>&SFCOBS_USELIST;</value>
    </envar>
    <envar>
      <name>PREPBUFR</name>
      <value>&PREPBUFR_DIR;</value>
    </envar>
    <envar>
      <name>NCEPSNOW</name>
      <value>&NCEPSNOW_DIR;</value>
    </envar>
    <envar>
      <name>SST_ROOT</name>
      <value>&HIGHRES_SST_DIR;</value>
    </envar>
    <envar>
      <name>SST_ROOT14km</name>
      <value>&HIGHRES_SST14KM_DIR;</value>
    </envar>
    <envar>
      <name>ENKF_FCST</name>
      <value>&ENKFFCST_DIR;</value>
    </envar>

    <dependency>
      <and>
          <datadep>&HRRR_DIR;/<cyclestr offset="-1:00:00">@Y@m@d@H</cyclestr>/wrfprd/<cyclestr>wrfout_d01_@Y-@m-@d_@H_00_00</cyclestr></datadep>
        <or> 
          <and>
            <datadep age="00:02:00"><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd/NSSLRefInGSI.bufr</cyclestr></datadep>
            <taskdep task="lightning_gsi_15"/>
            <taskdep task="lightning_gsi_30"/>
            <taskdep task="lightning_gsi_45"/>
            <taskdep task="lightning_gsi_60"/>
            <taskdep task="satellite_gsi_bufr"/>
            <or>
              <taskdep task="conventional_gsi"/>
              <taskdep task="conventional_gsi_early"/>
            </or>
          </and>
          <timedep><cyclestr offset="&START_TIME_GSI;">@Y@m@d@H@M00</cyclestr></timedep>
        </or>
      </and>
    </dependency>

  </task>

  <task name="gsi_diag" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &GSI_DIAG_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&SCRIPTS;/GSI/gsi_diag.ksh</command>
    <cores>&GSI_DIAG_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_gsi_diag_@H</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/gsi_diag_@Y@m@d@H00.log</cyclestr></join>

    <envar>
      <name>GSIPROC</name>
      <value>&GSI_DIAG_PROC;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATABASE_DIR</name>
      <value>&DATABASE_DIR;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>

    <dependency>
      <taskdep task="gsi_hyb"/>
    </dependency>

  </task>

  <task name="smartinit_bl" cycledefs="02-11hr,02hr,03hr,04hr,05hr,06hr,07hr,08hr,09hr,10hr,11hr,00hr" maxtries="3">

    &SMARTINIT_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION_SMARTINIT;

    <command>&SCRIPTS;/smartinit/hrrr_smartinit_bl.ksh</command>
    <cores>&SMARTINIT_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_smartinit_@H_bl</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/smartinit_@Y@m@d@H00_bl.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>EXE_ROOT</name>
      <value>&SMARTINIT_EXEC;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/smtiprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAPOSTHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/postprd</cyclestr></value>
    </envar>
    <envar>
      <name>MODEL</name>
      <value>HRRR</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/smartinit</value>
    </envar>

    <dependency>
      <datadep age="00:02:00">&DATAROOT;/<cyclestr>@Y@m@d@H</cyclestr>/postprd<cyclestr>/wrfnat_hrconus_00.grib2</cyclestr></datadep>
    </dependency>

   </task>

  <task name="smartinit_nb" cycledefs="02-11hr,02hr,03hr,04hr,05hr,06hr,07hr,08hr,09hr,10hr,11hr,00hr" maxtries="3">

    &SMARTINIT_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION_SMARTINIT;

    <command>&SCRIPTS;/smartinit/hrrr_smartinit_nb.ksh</command>
    <cores>&SMARTINIT_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_smartinit_@H_nb</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/smartinit_@Y@m@d@H00_nb.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>EXE_ROOT</name>
      <value>&SMARTINIT_EXEC;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/smtiprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAPOSTHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/postprd</cyclestr></value>
    </envar>
    <envar>
      <name>MODEL</name>
      <value>HRRR</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/smartinit</value>
    </envar>

    <dependency>
      <datadep age="00:02:00">&DATAROOT;/<cyclestr>@Y@m@d@H</cyclestr>/postprd<cyclestr>/wrfnat_hrconus_00.grib2</cyclestr></datadep>
    </dependency>

   </task>

  <task name="post_00" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &POST_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/UPP/unipost.ksh</command>
    <cores>&POST_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_post_@H_00</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/post_@Y@m@d@H00_00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>STATICWRF_DIR</name>
      <value>&STATIC_DIR;/WRF</value>
    </envar>
    <envar>
      <name>WRF_ROOT</name>
      <value>&WRF_ROOT;</value>
    </envar>
    <envar>
      <name>EXE_ROOT</name>
      <value>&UNIPOST_EXEC;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/postprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAWRFHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/gsiprd</cyclestr></value>
    </envar>
    <envar>
      <name>MODEL</name>
      <value>RAP</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/UPP</value>
    </envar>
    <envar>
      <name>POST_NAME</name>
      <value>&POST_NAME;</value>
    </envar>

    <dependency>
      <taskdep task="gsi_hyb"/>
    </dependency>

  </task>

  <task name="ncl_00" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr.ksh</command>
    <cores>&NCL_MAIN_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_00</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_00.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>NCL_VER</name>
      <value>&NCL_VER;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MODEL</name>
      <value>RTMA_3D</value>
    </envar>

    <dependency>
      <taskdep task="post_00"/>
    </dependency>

  </task>

  <metatask>
    <var name="skewt">skewt1 skewt2 skewt3 skewt4 skewt5</var>

    <task name="ncl_00_#skewt#" cycledefs="02-11hr,00hr,01hr" maxtries="3">

      &NCL_SKEWT_RESOURCES;
      &WALL_LIMIT_PP;
      &RESERVATION;

      <command>&SCRIPTS;/NCL/ncl_hrrr_#skewt#.ksh</command>
      <cores>&NCL_PROC;</cores>
      <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_00_#skewt#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_00_#skewt#.log</cyclestr></join>

      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>FCST_TIME</name>
        <value>00</value>
      </envar>
      <envar>
        <name>NCL_VER</name>
        <value>&NCL_VER;</value>
      </envar>
      <envar>
        <name>DATAROOT</name>
        <value>&DATAROOT;</value>
      </envar>
      <envar>
        <name>DATAHOME</name>
        <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MODEL</name>
        <value>RTMA_3D</value>
      </envar>

      <dependency>
        <taskdep task="post_00"/>
      </dependency>

    </task>

  </metatask>

  <metatask>
    <var name="htxs">htxs1</var>

    <task name="ncl_00_#htxs#" cycledefs="02-11hr,00hr,01hr" maxtries="3">

      &NCL_HTXS_RESOURCES;
      &WALL_LIMIT_PP;
      &RESERVATION;

      <command>&SCRIPTS;/NCL/ncl_hrrr_#htxs#.ksh</command>
      <cores>&NCL_PROC;</cores>
      <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_00_#htxs#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_00_#htxs#.log</cyclestr></join>

      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>FCST_TIME</name>
        <value>00</value>
      </envar>
      <envar>
        <name>NCL_VER</name>
        <value>&NCL_VER;</value>
      </envar>
      <envar>
        <name>DATAROOT</name>
        <value>&DATAROOT;</value>
      </envar>
      <envar>
        <name>DATAHOME</name>
        <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MODEL</name>
        <value>RTMA_3D</value>
      </envar>

      <dependency>
        <taskdep task="post_00"/>
      </dependency>

    </task>

  </metatask>

  <task name="ncl_zip" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr_zip.ksh</command>
    <cores>&NCL_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_zip</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_zip.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
      <or>
        <taskdep task="ncl_00"/>
        <timedep><cyclestr offset="03:00:00">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>
    
  </task>

  <task name="ncl_skewt_zip" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr_skewt_zip.ksh</command>
    <cores>&NCL_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_skewt_zip</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_skewt_zip.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
      <or>
        <and>
          <taskdep task="ncl_00_skewt1"/>
          <taskdep task="ncl_00_skewt2"/>
          <taskdep task="ncl_00_skewt3"/>
          <taskdep task="ncl_00_skewt4"/>
          <taskdep task="ncl_00_skewt5"/>
        </and>
        <timedep><cyclestr offset="03:00:00">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>
    
  </task>

  <task name="ncl_htxs_zip" cycledefs="02-11hr,00hr,01hr" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr_htxs_zip.ksh</command>
    <cores>&NCL_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_htxs_zip</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/ncl_@Y@m@d@H00_htxs_zip.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
      <or>
        <and>
          <taskdep task="ncl_00_htxs1"/>
        </and>
        <timedep><cyclestr offset="02:55:00">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>
    
  </task>

</workflow>
